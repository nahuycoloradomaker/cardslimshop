<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETERN SHOP</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
  <style>
    :root{--p:#00ff9d;--pd:#00cc7d;--s:#7b61ff;--bg:#0a0a0a;--c:#151515;--t:#fff;--d:#ff4757}
    body{background:var(--bg);color:var(--t);font-family:Montserrat,sans-serif;padding-bottom:100px}
    h1{font-family:Orbitron,sans-serif;font-size:42px;text-align:center;background:linear-gradient(90deg,var(--p),var(--s));-webkit-background-clip:text;color:transparent}
    .balance{background:var(--c);padding:20px;border-radius:20px;margin:20px;text-align:center;font-size:32px;font-weight:bold;border:2px solid var(--p)}
    .cards{display:grid;gap:20px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));padding:20px}
    .card{background:var(--c);border-radius:20px;overflow:hidden;position:relative;box-shadow:0 10px 20px rgba(0,0,0,.5)}
    .card img{width:100%;height:180px;object-fit:cover}
    .info{padding:20px}
    .name{font-size:20px;font-weight:bold}
    .rarity{margin:10px 0;color:#aaa}
    .price{font-size:28px;color:var(--p);font-weight:bold}
    .stock{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.8);padding:5px 12px;border-radius:20px;font-size:14px}
    .buy{width:100%;padding:16px;background:var(--p);color:#000;border:none;font-weight:bold;font-size:18px;cursor:pointer}
    .soldout{opacity:.6;pointer-events:none}
    .soldout .buy{background:#444;color:#888}
    .soldout::after{content:"РАСПРОДАНО";position:absolute;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;font-size:32px;color:var(--d);font-weight:bold}
    .empty{text-align:center;padding:80px;font-size:24px;color:#aaa}
    .close{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:16px 50px;background:#333;color:white;border-radius:30px;font-size:18px;cursor:pointer}
  </style>
</head>
<body>
  <h1>ETERN SHOP</h1>
  <div class="balance">Баланс: <span id="bal">—</span> ₭</div>
  <div class="cards" id="list"><div class="empty">Грузим лимитки...</div></div>
  <button class="close" onclick="Telegram.WebApp.close()">ЗАКРЫТЬ</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready();
    const userId = tg.initDataUnsafe.user?.id;

    async function load() {
      try {
        const r = await fetch(`https://eternium-shop.onrender.com/shop?user_id=${userId}&t=${Date.now()}`);
        const d = await r.json();
        document.getElementById("bal").textContent = Number(d.balance).toLocaleString();

        const list = document.getElementById("list");
        list.innerHTML = d.cards.length === 0 
          ? '<div class="empty">НЕТ ХУЙНИ В ПРОДАЖЕ<br>Жди от админа Red Circle</div>'
          : '';

        d.cards.forEach(c => {
          const left = c.stock === 0 ? "∞" : c.stock - c.sold;
          const soldout = left !== "∞" && left <= 0;

          const div = document.createElement("div");
          div.className = "card" + (soldout ? " soldout" : "");
          div.innerHTML = `
            <img src="${c.photo}">
            <div class="stock">${left} шт.</div>
            <div class="info">
              <div class="name">${c.name}</div>
              <div class="rarity">${c.rarity}</div>
              <div class="price">${c.price.toLocaleString()} ₭</div>
              <button class="buy" ${soldout?'disabled':''} onclick="buy(${c.id})">
                ${soldout?'РАСПРОДАНО':'КУПИТЬ'}
              </button>
            </div>
          `;
          list.appendChild(div);
        });
      } catch(e) {
        document.getElementById("list").innerHTML = '<div class="empty" style="color:red">ПИЗДЕЦ, НЕ ГРУЗИТСЯ<br>Админ спит</div>';
      }
    }

    function buy(id) {
      confetti({particleCount:200,spread:100,origin:{y:0.6}});
      fetch("https://eternium-shop.onrender.com/buy", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({user_id:userId, card_id:id})
      });
      setTimeout(() => location.reload(), 1200);
    }

    load();
    setInterval(load, 8000);
  </script>
</body>
</html>
